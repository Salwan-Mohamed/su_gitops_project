apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  labels:
    managed-by: gitops
    component: monitoring
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: infrastructure
  
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 55.5.0
    helm:
      releaseName: kube-prometheus-stack
      values: |
        # Prometheus configuration
        prometheus:
          prometheusSpec:
            retention: 15d
            
            # Use NFS storage
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: nfs-client
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 20Gi
            
            resources:
              requests:
                cpu: 500m
                memory: 2Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            
            scrapeInterval: 30s
            evaluationInterval: 30s
            
            # Monitor all namespaces
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false
            ruleSelectorNilUsesHelmValues: false
            
            # Scrape ArgoCD metrics
            additionalScrapeConfigs:
              - job_name: 'argocd-metrics'
                static_configs:
                  - targets: ['argocd-metrics.argocd.svc.cluster.local:8082']
              - job_name: 'argocd-server-metrics'
                static_configs:
                  - targets: ['argocd-server-metrics.argocd.svc.cluster.local:8083']
              - job_name: 'argocd-repo-server-metrics'
                static_configs:
                  - targets: ['argocd-repo-server.argocd.svc.cluster.local:8084']
            
            # Node affinity - avoid worker04
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                  - matchExpressions:
                    - key: kubernetes.io/hostname
                      operator: NotIn
                      values:
                      - worker04
        
        # AlertManager
        alertmanager:
          enabled: true
          alertmanagerSpec:
            retention: 120h
            
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: nfs-client
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi
            
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 200m
                memory: 512Mi
            
            # Node affinity - avoid worker04
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                  - matchExpressions:
                    - key: kubernetes.io/hostname
                      operator: NotIn
                      values:
                      - worker04
        
        # Grafana - DISABLED PERSISTENCE FOR NOW
        grafana:
          enabled: true
          adminPassword: "admin"
          
          # Disable persistence temporarily
          persistence:
            enabled: false
          
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          
          # Expose via LoadBalancer
          service:
            type: LoadBalancer
          
          # Datasources
          datasources:
            datasources.yaml:
              apiVersion: 1
              datasources:
                - name: Prometheus
                  type: prometheus
                  url: http://kube-prometheus-stack-prometheus.platform-monitoring:9090
                  access: proxy
                  isDefault: true
                  jsonData:
                    timeInterval: 30s
          
          # Node affinity - avoid worker04
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: NotIn
                    values:
                    - worker04
        
        # Node Exporter - runs on ALL nodes
        nodeExporter:
          enabled: true
        
        # Kube State Metrics
        kubeStateMetrics:
          enabled: true
        
        # Prometheus Operator
        prometheusOperator:
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          # Node affinity - avoid worker04
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: NotIn
                    values:
                    - worker04
  
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-monitoring
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/volumeClaimTemplates
