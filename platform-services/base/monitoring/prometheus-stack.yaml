apiVersion: v1
kind: Namespace
metadata:
  name: platform-monitoring
  labels:
    managed-by: gitops
    component: monitoring
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  labels:
    managed-by: gitops
    component: monitoring
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: infrastructure
  
  source:
    # Official Prometheus Community Helm Chart
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 55.5.0  # Stable version
    helm:
      releaseName: kube-prometheus-stack
      values: |
        # Prometheus configuration
        prometheus:
          prometheusSpec:
            retention: 15d
            retentionSize: "50GB"
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 50Gi
            resources:
              requests:
                cpu: 500m
                memory: 2Gi
              limits:
                cpu: 2000m
                memory: 4Gi
            # Scrape interval
            scrapeInterval: 30s
            evaluationInterval: 30s
            
            # ServiceMonitor selector - monitor all namespaces
            serviceMonitorSelectorNilUsesHelmValues: false
            podMonitorSelectorNilUsesHelmValues: false
            ruleSelectorNilUsesHelmValues: false
            
            # Additional scrape configs for ArgoCD metrics
            additionalScrapeConfigs:
              - job_name: 'argocd-metrics'
                static_configs:
                  - targets: ['argocd-metrics.argocd.svc.cluster.local:8082']
              - job_name: 'argocd-server-metrics'
                static_configs:
                  - targets: ['argocd-server-metrics.argocd.svc.cluster.local:8083']
              - job_name: 'argocd-repo-server-metrics'
                static_configs:
                  - targets: ['argocd-repo-server.argocd.svc.cluster.local:8084']
        
        # AlertManager configuration
        alertmanager:
          enabled: true
          alertmanagerSpec:
            retention: 120h
            storage:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 200m
                memory: 512Mi
        
        # Grafana configuration
        grafana:
          enabled: true
          adminPassword: "admin"  # Change this in production!
          persistence:
            enabled: true
            size: 10Gi
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          
          # Grafana service - expose via LoadBalancer
          service:
            type: LoadBalancer
            annotations:
              metallb.universe.tf/address-pool: default
          
          # Additional dashboards
          dashboardProviders:
            dashboardproviders.yaml:
              apiVersion: 1
              providers:
                - name: 'default'
                  orgId: 1
                  folder: ''
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards/default
                - name: 'argocd'
                  orgId: 1
                  folder: 'ArgoCD'
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards/argocd
                - name: 'dora'
                  orgId: 1
                  folder: 'DORA Metrics'
                  type: file
                  disableDeletion: false
                  editable: true
                  options:
                    path: /var/lib/grafana/dashboards/dora
          
          # Pre-configure datasources
          datasources:
            datasources.yaml:
              apiVersion: 1
              datasources:
                - name: Prometheus
                  type: prometheus
                  url: http://kube-prometheus-stack-prometheus.platform-monitoring:9090
                  access: proxy
                  isDefault: true
                  jsonData:
                    timeInterval: 30s
        
        # Node Exporter - for node-level metrics
        nodeExporter:
          enabled: true
        
        # Kube State Metrics - for Kubernetes object metrics
        kubeStateMetrics:
          enabled: true
        
        # Prometheus Operator
        prometheusOperator:
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
  
  destination:
    server: https://kubernetes.default.svc
    namespace: platform-monitoring
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true  # Required for CRDs
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  # Ignore differences in generated secrets
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/volumeClaimTemplates
